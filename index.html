
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amarilla Superintendent Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .icon { display: inline-block; width: 20px; height: 20px; vertical-align: middle; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen p-4 md:p-8">
        <div class="max-w-7xl mx-auto">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <!-- Header -->
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Superintendent Dashboard</h1>
                        <p class="text-gray-600 mt-1">Residencia Martinez - Self-Perform Time & Task Management</p>
                    </div>
                    <div class="text-sm text-gray-700">
                        <span class="font-medium">User:</span> <span id="currentUser">Roberto Sanchez (Superintendent)</span>
                    </div>
                </div>

                <!-- View Toggle -->
                <div class="flex gap-4 mb-6 bg-gray-100 p-1 rounded-lg">
                    <button onclick="showView('timesheet')" id="btnTimesheet" class="flex-1 py-3 px-4 rounded-lg font-medium transition">
                        ‚è∞ Log Crew Time
                    </button>
                    <button onclick="showView('tasks')" id="btnTasks" class="flex-1 py-3 px-4 rounded-lg font-medium transition">
                        ‚öôÔ∏è Manage Tasks
                    </button>
                </div>

                <!-- Timesheet View -->
                <div id="viewTimesheet" class="hidden">
                    <div class="bg-orange-50 rounded-lg p-6 border-2 border-orange-200">
                        <div class="flex items-center gap-2 mb-4">
                            <h2 class="text-lg font-semibold text-orange-900">üë• Crew Time Entry</h2>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                            <input type="date" id="selectedDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>

                        <!-- Step 1: Select Task -->
                        <div id="stepSelectTask">
                            <h3 class="font-semibold mb-3">Select Task with Available Hours</h3>
                            <div id="tasksList"></div>
                        </div>

                        <!-- Step 2: Select Detail -->
                        <div id="stepSelectDetail" class="hidden">
                            <button onclick="backToTaskSelection()" class="text-orange-600 hover:text-orange-800 mb-4 text-sm font-medium">
                                ‚Üê Back to task selection
                            </button>
                            <div id="taskContext" class="bg-white rounded-lg p-4 mb-4 border-2 border-orange-300"></div>
                            <h3 class="font-semibold mb-3">What area/detail did the crew work on?</h3>
                            <div id="detailsList"></div>
                        </div>

                        <!-- Step 3: Assign Workers -->
                        <div id="stepAssignWorkers" class="hidden">
                            <button onclick="backToPreviousStep()" class="text-orange-600 hover:text-orange-800 mb-4 text-sm font-medium">
                                ‚Üê Back
                            </button>
                            <div id="taskContextFull" class="bg-white rounded-lg p-4 mb-4 border-2 border-orange-300"></div>
                            
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-semibold">Select Workers</h3>
                                <button onclick="toggleAllWorkers()" class="text-sm text-orange-600 hover:text-orange-800 font-medium">
                                    Select All
                                </button>
                            </div>
                            
                            <div id="workersList" class="space-y-2 mb-4"></div>
                            
                            <div id="selectedSummary" class="bg-orange-100 rounded-lg p-3 mb-4 text-sm hidden"></div>
                            
                            <button onclick="logCrewTime()" class="w-full px-4 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition font-medium">
                                ‚è∞ Log Time for Selected Workers
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tasks Management View -->
                <div id="viewTasks" class="hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold">Task Status Management</h2>
                        <button onclick="toggleShowClosed()" id="btnShowClosed" class="px-4 py-2 rounded-lg transition bg-gray-200 text-gray-700 hover:bg-gray-300">
                            üëÅÔ∏è Showing Open Only
                        </button>
                    </div>

                    <div class="bg-blue-50 rounded-lg p-4 mb-4 border border-blue-200">
                        <p class="text-sm text-blue-900">
                            <strong>Tip:</strong> Click status badges to open/close tasks. Closed tasks won't appear in crew time entry. Reopen tasks when rework is needed.
                        </p>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full bg-white rounded-lg overflow-hidden">
                            <thead>
                                <tr class="bg-gray-100 border-b border-gray-200">
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Status</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Group ‚Üí Activity</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Location</th>
                                    <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Budget</th>
                                    <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Used</th>
                                    <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Available</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Progress</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Detail Tracking</th>
                                </tr>
                            </thead>
                            <tbody id="tasksTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Today's Summary -->
                <div id="todaysSummary" class="mt-6 bg-gray-50 rounded-lg p-4 hidden">
                    <h3 class="font-semibold mb-3">Today's Logged Hours (<span id="summaryDate"></span>)</h3>
                    <div id="entriesList" class="space-y-2 mb-4"></div>
                    <div id="workerTotals" class="mt-4 pt-4 border-t border-gray-300"></div>
                    <div class="mt-3 pt-3 border-t border-gray-300">
                        <div class="flex justify-between font-semibold">
                            <span>Total Hours Today:</span>
                            <span class="text-orange-600" id="totalHoursToday">0h</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data
        let tasks = [
            { id: 't1', groupName: 'Concrete', activityName: 'Foundation Pour', location: 'Foundation Area', budgetHours: 140, usedHours: 140, estimatedCompletion: 1.0, trackByDetail: false, availableDetails: ['Footings', 'Grade Beams', 'Piers'], status: 'closed' },
            { id: 't2', groupName: 'Drywall', activityName: 'Framing', location: '1st & 2nd Floor', budgetHours: 375, usedHours: 280, estimatedCompletion: 0.75, trackByDetail: true, availableDetails: ['Nichos', 'Ceilings', 'Walls'], status: 'open' },
            { id: 't3', groupName: 'Drywall', activityName: 'Board Installation', location: '1st & 2nd Floor', budgetHours: 280, usedHours: 120, estimatedCompletion: 0.45, trackByDetail: true, availableDetails: ['Level 5 Finish', 'Standard Finish', 'Moisture Resistant'], status: 'open' },
            { id: 't4', groupName: 'Drywall', activityName: 'Plaster & Finish', location: '1st & 2nd Floor', budgetHours: 220, usedHours: 0, estimatedCompletion: 0, trackByDetail: false, availableDetails: [], status: 'open' },
            { id: 't5', groupName: 'MEP', activityName: 'Electrical Rough-In', location: 'All Floors', budgetHours: 160, usedHours: 145, estimatedCompletion: 0.95, trackByDetail: true, availableDetails: ['Conduit', 'Junction Boxes', 'Panel Install'], status: 'open' },
            { id: 't6', groupName: 'MEP', activityName: 'Plumbing Rough-In', location: 'All Floors', budgetHours: 140, usedHours: 140, estimatedCompletion: 1.0, trackByDetail: false, availableDetails: ['Supply Lines', 'Drain Lines', 'Vents'], status: 'closed' }
        ];

        const workers = [
            { id: 'w1', name: 'Carlos Martinez', trade: 'Carpenter' },
            { id: 'w2', name: 'Jose Rodriguez', trade: 'Carpenter' },
            { id: 'w3', name: 'Miguel Santos', trade: 'Laborer' },
            { id: 'w4', name: 'Juan Hernandez', trade: 'Electrician' },
            { id: 'w5', name: 'Luis Garcia', trade: 'Carpenter' },
            { id: 'w6', name: 'Pedro Ramirez', trade: 'Laborer' }
        ];

        let entries = [];
        let currentView = 'timesheet';
        let showClosedTasks = false;
        let selectedTask = null;
        let selectedDetail = null;
        let selectedWorkers = [];
        let workerHours = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('selectedDate').valueAsDate = new Date();
            showView('timesheet');
        });

        function showView(view) {
            currentView = view;
            document.getElementById('viewTimesheet').classList.toggle('hidden', view !== 'timesheet');
            document.getElementById('viewTasks').classList.toggle('hidden', view !== 'tasks');
            
            document.getElementById('btnTimesheet').className = view === 'timesheet' 
                ? 'flex-1 py-3 px-4 rounded-lg font-medium transition bg-white text-orange-600 shadow'
                : 'flex-1 py-3 px-4 rounded-lg font-medium transition text-gray-600 hover:text-gray-900';
            
            document.getElementById('btnTasks').className = view === 'tasks'
                ? 'flex-1 py-3 px-4 rounded-lg font-medium transition bg-white text-blue-600 shadow'
                : 'flex-1 py-3 px-4 rounded-lg font-medium transition text-gray-600 hover:text-gray-900';

            if (view === 'timesheet') {
                renderTasksList();
            } else {
                renderTasksTable();
            }
            updateSummary();
        }

        function getTasksWithSaldo() {
            const organized = {};
            const openTasks = tasks.filter(t => t.status === 'open');
            
            openTasks.forEach(task => {
                const usedTotal = task.usedHours + calculateTaskHours(task.id);
                const available = task.budgetHours - usedTotal;
                
                if (available > 0) {
                    if (!organized[task.groupName]) {
                        organized[task.groupName] = { groupName: task.groupName, tasks: [] };
                    }
                    organized[task.groupName].tasks.push({
                        ...task,
                        currentUsed: usedTotal,
                        available: available
                    });
                }
            });
            
            return Object.values(organized);
        }

        function calculateTaskHours(taskId) {
            return entries.filter(e => e.taskId === taskId).reduce((sum, e) => sum + e.hours, 0);
        }

        function renderTasksList() {
            const groups = getTasksWithSaldo();
            const container = document.getElementById('tasksList');
            
            if (groups.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-600"><p>No open tasks with available hours</p><button onclick="showView(\'tasks\')" class="mt-4 text-blue-600 hover:text-blue-800 underline">Go to Task Management to open tasks</button></div>';
                return;
            }
            
            container.innerHTML = groups.map(group => `
                <div class="bg-white rounded-lg border-2 border-gray-200 overflow-hidden mb-4">
                    <div class="bg-gray-100 px-4 py-2 border-b border-gray-200">
                        <div class="font-semibold text-gray-900">${group.groupName}</div>
                    </div>
                    <div class="divide-y divide-gray-200">
                        ${group.tasks.map(task => `
                            <button onclick='selectTask(${JSON.stringify(task).replace(/'/g, "&apos;")})' class="w-full bg-white hover:bg-orange-50 transition text-left p-4 hover:border-l-4 hover:border-orange-400">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="font-medium text-gray-900">${task.activityName}</span>
                                            ${task.trackByDetail ? '<span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-medium">DETAIL REQUIRED</span>' : ''}
                                        </div>
                                        <div class="text-sm text-gray-600 mb-2">üìç ${task.location}</div>
                                        <div class="grid grid-cols-3 gap-2 text-xs">
                                            <div><span class="text-gray-600">Budget:</span> <span class="font-medium ml-1">${task.budgetHours}h</span></div>
                                            <div><span class="text-gray-600">Available:</span> <span class="font-medium ml-1 text-green-700">${task.available}h</span></div>
                                            <div><span class="text-gray-600">Progress:</span> <span class="font-medium ml-1">${(task.estimatedCompletion * 100).toFixed(0)}%</span></div>
                                        </div>
                                    </div>
                                    <span class="text-gray-400 mt-1">‚Üí</span>
                                </div>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function selectTask(task) {
            selectedTask = task;
            selectedDetail = null;
            selectedWorkers = [];
            workerHours = {};
            
            if (task.trackByDetail) {
                showStep('selectDetail');
                renderDetails();
            } else {
                showStep('assignWorkers');
                renderWorkers();
            }
        }

        function renderDetails() {
            document.getElementById('taskContext').innerHTML = `
                <div class="text-sm text-gray-600 mb-1">${selectedTask.groupName} ‚Üí ${selectedTask.activityName}</div>
                <div class="font-semibold text-gray-900">üìç ${selectedTask.location}</div>
            `;
            
            document.getElementById('detailsList').innerHTML = selectedTask.availableDetails.map(detail => `
                <button onclick="selectDetail('${detail}')" class="w-full bg-white rounded-lg p-4 border-2 border-gray-200 hover:border-orange-400 hover:bg-orange-50 transition text-left flex items-center justify-between mb-2">
                    <span class="font-medium text-gray-900">${detail}</span>
                    <span class="text-gray-400">‚Üí</span>
                </button>
            `).join('');
        }

        function selectDetail(detail) {
            selectedDetail = detail;
            showStep('assignWorkers');
            renderWorkers();
        }

        function renderWorkers() {
            document.getElementById('taskContextFull').innerHTML = `
                <div class="text-sm text-gray-600 mb-1">
                    ${selectedTask.groupName} ‚Üí ${selectedTask.activityName}
                    ${selectedDetail ? ` ‚Üí ${selectedDetail}` : ''}
                </div>
                <div class="font-semibold text-gray-900">üìç ${selectedTask.location}</div>
            `;
            
            const selectedDate = document.getElementById('selectedDate').value;
            const container = document.getElementById('workersList');
            
            container.innerHTML = workers.map(worker => {
                const hoursToday = getWorkerHoursToday(worker.id);
                const isSelected = selectedWorkers.includes(worker.id);
                const hours = workerHours[worker.id] || 8;
                const totalIfAdded = hoursToday + hours;
                
                return `
                    <div class="rounded-lg p-4 border-2 transition ${isSelected ? 'bg-orange-100 border-orange-500' : 'bg-white border-gray-200'}">
                        <div class="flex items-center gap-3">
                            <button onclick="toggleWorker('${worker.id}')" class="flex-shrink-0">
                                ${isSelected ? '‚òëÔ∏è' : '‚¨ú'}
                            </button>
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">${worker.name}</div>
                                <div class="text-sm text-gray-600">${worker.trade}</div>
                                ${hoursToday > 0 ? `
                                    <div class="text-xs text-blue-700 mt-1 font-medium">
                                        Already logged: ${hoursToday}h today
                                        ${isSelected ? ` ‚Üí Total will be: ${totalIfAdded}h` : ''}
                                    </div>
                                ` : ''}
                            </div>
                            ${isSelected ? `
                                <input type="number" step="0.5" value="${hours}" onchange="updateWorkerHours('${worker.id}', this.value)" class="w-16 px-2 py-1 border border-orange-300 rounded text-center">
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            updateSelectedSummary();
        }

        function toggleWorker(workerId) {
            if (selectedWorkers.includes(workerId)) {
                selectedWorkers = selectedWorkers.filter(id => id !== workerId);
                delete workerHours[workerId];
            } else {
                selectedWorkers.push(workerId);
                workerHours[workerId] = 8;
            }
            renderWorkers();
        }

        function toggleAllWorkers() {
            if (selectedWorkers.length === workers.length) {
                selectedWorkers = [];
                workerHours = {};
            } else {
                selectedWorkers = workers.map(w => w.id);
                workers.forEach(w => workerHours[w.id] = 8);
            }
            renderWorkers();
        }

        function updateWorkerHours(workerId, hours) {
            workerHours[workerId] = parseFloat(hours) || 0;
            updateSelectedSummary();
        }

        function updateSelectedSummary() {
            const summary = document.getElementById('selectedSummary');
            if (selectedWorkers.length > 0) {
                const totalHours = selectedWorkers.reduce((sum, id) => sum + (workerHours[id] || 8), 0);
                summary.innerHTML = `<span class="font-medium">${selectedWorkers.length} workers selected</span><span class="text-gray-700 ml-2">√ó total = ${totalHours} hours</span>`;
                summary.classList.remove('hidden');
            } else {
                summary.classList.add('hidden');
            }
        }

        function getWorkerHoursToday(workerId) {
            const selectedDate = document.getElementById('selectedDate').value;
            return entries.filter(e => e.date === selectedDate && e.workerId === workerId).reduce((sum, e) => sum + e.hours, 0);
        }

        function logCrewTime() {
            if (selectedWorkers.length === 0) {
                alert('Please select at least one worker');
                return;
            }
            
            const selectedDate = document.getElementById('selectedDate').value;
            
            selectedWorkers.forEach(workerId => {
                const worker = workers.find(w => w.id === workerId);
                const hours = workerHours[workerId] || 8;
                
                entries.push({
                    id: Date.now() + Math.random(),
                    date: selectedDate,
                    employee: worker.name,
                    workerId: worker.id,
                    hours: hours,
                    location: selectedTask.location,
                    task: selectedTask.activityName,
                    detailName: selectedDetail,
                    groupName: selectedTask.groupName,
                    taskId: selectedTask.id,
                    foreman: 'Roberto Sanchez'
                });
            });
            
            selectedTask = null;
            selectedDetail = null;
            selectedWorkers = [];
            workerHours = {};
            
            showStep('selectTask');
            renderTasksList();
            updateSummary();
        }

        function showStep(step) {
            document.getElementById('stepSelectTask').classList.toggle('hidden', step !== 'selectTask');
            document.getElementById('stepSelectDetail').classList.toggle('hidden', step !== 'selectDetail');
            document.getElementById('stepAssignWorkers').classList.toggle('hidden', step !== 'assignWorkers');
        }

        function backToTaskSelection() {
            selectedTask = null;
            selectedDetail = null;
            showStep('selectTask');
        }

        function backToPreviousStep() {
            if (selectedTask.trackByDetail && !selectedDetail) {
                backToTaskSelection();
            } else if (selectedTask.trackByDetail) {
                selectedDetail = null;
                showStep('selectDetail');
                renderDetails();
            } else {
                backToTaskSelection();
            }
        }

        function renderTasksTable() {
            const filtered = showClosedTasks ? tasks : tasks.filter(t => t.status === 'open');
            const tbody = document.getElementById('tasksTableBody');
            
            tbody.innerHTML = filtered.map(task => {
                const available = task.budgetHours - task.usedHours;
                return `
                    <tr class="border-b border-gray-200 hover:bg-gray-50 ${task.status === 'closed' ? 'bg-gray-50 opacity-60' : ''}">
                        <td class="px-4 py-3">
                            <button onclick="toggleTaskStatus('${task.id}')" class="text-xs px-3 py-1.5 rounded-full font-semibold ${task.status === 'open' ? 'bg-green-100 text-green-700 hover:bg-green-200' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}">
                                ${task.status === 'open' ? 'OPEN' : 'CLOSED'}
                            </button>
                        </td>
                        <td class="px-4 py-3"><div class="font-medium text-gray-900">${task.groupName} ‚Üí ${task.activityName}</div></td>
                        <td class="px-4 py-3 text-sm text-gray-600">${task.location}</td>
                        <td class="px-4 py-3 text-sm text-right text-gray-700">${task.budgetHours}h</td>
                        <td class="px-4 py-3 text-sm text-right text-orange-700">${task.usedHours}h</td>
                        <td class="px-4 py-3 text-sm text-right font-medium ${available > 0 ? 'text-green-700' : 'text-red-700'}">${available}h</td>
                        <td class="px-4 py-3 text-center"><div class="inline-block bg-blue-100 px-3 py-1 rounded-full"><span class="text-sm font-semibold text-blue-700">${(task.estimatedProgress * 100).toFixed(0)}%</span></div></td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="toggleTrackByDetail('${task.id}')" ${task.status === 'closed' ? 'disabled' : ''} class="text-xs font-medium px-3 py-1.5 rounded-full ${task.trackByDetail ? 'bg-blue-100 text-blue-700 hover:bg-blue-200' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'} ${task.status === 'closed' ? 'opacity-50 cursor-not-allowed' : ''}">
                                ${task.trackByDetail ? 'ON' : 'OFF'}
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function toggleTaskStatus(taskId) {
            const task = tasks.find(t => t.id === taskId);
            task.status = task.status === 'open' ? 'closed' : 'open';
            renderTasksTable();
            if (currentView === 'timesheet') renderTasksList();
        }

        function toggleTrackByDetail(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task.status !== 'closed') {
                task.trackByDetail = !task.trackByDetail;
                renderTasksTable();
            }
        }

        function toggleShowClosed() {
            showClosedTasks = !showClosedTasks;
            document.getElementById('btnShowClosed').innerHTML = showClosedTasks ? 'üëÅÔ∏è Showing All' : 'üôà Showing Open Only';
            renderTasksTable();
        }

        function updateSummary() {
            const selectedDate = document.getElementById('selectedDate').value;
            const todayEntries = entries.filter(e => e.date === selectedDate);
            
            if (todayEntries.length === 0) {
                document.getElementById('todaysSummary').classList.add('hidden');
                return;
            }
            
            document.getElementById('todaysSummary').classList.remove('hidden');
            document.getElementById('summaryDate').textContent = selectedDate;
            
            document.getElementById('entriesList').innerHTML = todayEntries.map(entry => `
                <div class="bg-white rounded p-3 text-sm border border-gray-200">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="font-medium">${entry.employee}</span>
                            <div class="text-gray-600 text-xs mt-1">${entry.groupName} ‚Üí ${entry.task}${entry.detailName ? ` ‚Üí ${entry.detailName}` : ''}</div>
                            <div class="text-gray-500 text-xs mt-1">${entry.location}</div>
                        </div>
                        <span class="font-semibold text-orange-600">${entry.hours}h</span>
                    </div>
                </div>
            `).join('');
            
            const workerTotalsHtml = workers.map(worker => {
                const total = getWorkerHoursToday(worker.id);
                return total > 0 ? `<div class="text-sm"><span class="text-gray-700">${worker.name}:</span><span class="font-semibold text-orange-600 ml-1">${total}h</span></div>` : '';
            }).filter(Boolean).join('');
            
            if (workerTotalsHtml) {
                document.getElementById('workerTotals').innerHTML = `
                    <h4 class="text-sm font-semibold mb-2 text-gray-700">Hours by Worker:</h4>
                    <div class="grid grid-cols-2 gap-2">${workerTotalsHtml}</div>
                `;
            }
            
            const totalHours = todayEntries.reduce((sum, e) => sum + e.hours, 0);
            document.getElementById('totalHoursToday').textContent = totalHours + 'h';
        }
    </script>
</body>
</html>